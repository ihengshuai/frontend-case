var Z=Object.defineProperty,ee=Object.defineProperties;var ue=Object.getOwnPropertyDescriptors;var V=Object.getOwnPropertySymbols;var ae=Object.prototype.hasOwnProperty,le=Object.prototype.propertyIsEnumerable;var q=(d,t,a)=>t in d?Z(d,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):d[t]=a,H=(d,t)=>{for(var a in t||(t={}))ae.call(t,a)&&q(d,a,t[a]);if(V)for(var a of V(t))le.call(t,a)&&q(d,a,t[a]);return d},N=(d,t)=>ee(d,ue(t));var p=(d,t,a)=>new Promise((T,F)=>{var b=l=>{try{s(a.next(l))}catch(o){F(o)}},m=l=>{try{s(a.throw(l))}catch(o){F(o)}},s=l=>l.done?T(l.value):Promise.resolve(l.value).then(b,m);s((a=a.apply(d,t)).next())});import{I as te,u as ne,i as ie}from"./index.Dmkzir.js";import{m as B,j as se,o as R,p as S,B as W,D as U,q as oe,r as $}from"./antd-BcJUCkMQ.js";import{d as ce,f as h,c as x,b as de,w as re,k as u,E as f,F as _,x as ve}from"./vue-BMZVVpNU.js";const me=ce({name:"MediaRecorderPage",setup(){const d=ne(),t=ie(),a=t?"video/mp4":"video/webm;codecs=h264",T=t?"audio/mp3":"audio/webm",F=h(!1),b=h(),m=h();let s,l,o,E=h([]);const C=x(()=>[...E.value.filter(n=>n.kind==="audioinput"),{label:"禁用",deviceId:"disabled",value:"disabled"}]),w=x(()=>[...E.value.filter(n=>n.kind==="videoinput"),{label:"屏幕或应用",deviceId:"screen",value:"screen"},{label:"禁用",deviceId:"disabled",value:"disabled"}]),G=x(()=>C.value.length===1),j=x(()=>w.value.length===1),c=h(""),r=h(""),D=[],g=h([]);M();function J(){return p(this,null,function*(){try{if(c.value==="disabled"&&r.value==="disabled"){B.warn("由于您禁用了媒体设备，暂不能录制!");return}if(F.value){o==null||o.stop();return}F.value=!0,yield ve(),b.value.srcObject=null,r.value==="screen"&&(s=yield navigator.mediaDevices.getDisplayMedia({video:{width:1920,height:1080},audio:c.value==="disabled"?!1:{deviceId:c.value}})),(c.value!=="disabled"||r.value!=="screen")&&(l=yield navigator.mediaDevices.getUserMedia({audio:c.value==="disabled"?!1:{deviceId:c.value},video:r.value==="disabled"||r.value==="screen"?!1:{deviceId:r.value,width:1920,height:1080}})),yield K()}catch(e){console.log("出错了...",e),(e==null?void 0:e.message)==="Permission denied"?B.warn("请打开浏览器的麦克风和摄像头权限"):e!=null&&e.message&&B.error(e==null?void 0:e.message),F.value=!1,P()}})}function K(){return p(this,null,function*(){r.value==="screen"?(c.value!=="disabled"&&l.getAudioTracks().forEach(e=>s==null?void 0:s.addTrack(e)),o=new MediaRecorder(s,{mimeType:a}),b.value.srcObject=s):(o=new MediaRecorder(l,{mimeType:r.value!=="disabled"?a:T}),b.value.srcObject=l),o&&(Q(),o.ondataavailable=e=>{D.push(e.data)},o.start(1e3),o.onpause=()=>{console.log("暂停...")},o.onstop=()=>{const e=new Blob(D,{type:a}),n=URL.createObjectURL(e),v=`在线录制__${+new Date}__${g.value.length+1}`;g.value.push({label:v,url:n}),D.length=0,F.value=!1,l==null||l.getTracks().forEach(i=>i.stop()),s==null||s.getTracks().forEach(i=>i.stop()),M()})})}function Q(){return p(this,null,function*(){if(c.value==="disabled")return;const e=new AudioContext,n=e.createMediaStreamSource(s||l),v=e.createAnalyser();n.connect(v),v.fftSize=2048;const i=m.value.getContext("2d"),I=m.value.width,y=m.value.height,L=()=>{const O=new Uint8Array(v.fftSize);v.getByteTimeDomainData(O),i.clearRect(0,I,0,y),i.beginPath(),i.fillStyle=d.isLightMode?"#fff":"#000",i.strokeStyle=d.isLightMode?"#000":"#fff",i.fillRect(0,0,I,y),i.lineWidth=1;const Y=I/v.fftSize;let A=0;i.moveTo(A,y/2);for(let k=0;k<v.fftSize;k++){const z=O[k]/128*y/2;k===0?i.moveTo(A,z):i.lineTo(A,z),A+=Y}i.stroke(),requestAnimationFrame(L)};L()})}function M(){return p(this,null,function*(){let e=yield navigator.mediaDevices.enumerateDevices();e=e.filter(n=>n.kind==="videoinput"||n.kind==="audioinput").map((n,v)=>N(H({},n),{kind:n.kind,label:n.label||"未知设备"+v,deviceId:n.deviceId||"device-id-"+v,value:n.deviceId||"device-id-"+v})),E.value.length&&e.length!==E.value.length&&B.info("已捕获到新可用的媒体设备，请在下拉框中查看"),E.value=e})}function X(v){return p(this,arguments,function*({url:e,label:n}){const i=document.createElement("a");i.href=e,i.download=n+t?c.value==="disabled"?"mp4":"mp3":".webm",i.click()})}function P(){return p(this,null,function*(){F.value=!1,g.value.forEach(e=>URL.revokeObjectURL(e.url)),g.value.length=0,D.length=0,o==null||o.stop(),l==null||l.getTracks().forEach(e=>e.stop()),s==null||s.getTracks().forEach(e=>e.stop())})}return de(P),re([C,w],()=>{c.value=c.value&&c.value!=="disabled"?c.value:C.value[0].deviceId,r.value=r.value&&r.value!=="disabled"?r.value:w.value[0].deviceId}),()=>u(te,{style:"max-width: 900px;margin: 12px auto"},{default:()=>[u("h2",{style:"text-align:center"},[f("在线录制")]),u(se,{type:"info",showIcon:!0,message:u(_,null,[f("在线录制包含摄像头、麦克风、屏幕、应用，摄像头和麦克可以自由组合或者禁用进行录制，录制的成品都为webm格式，如果你先要转换成其他格式请自行处理，webm格式可直接在浏览器中打开"),u("br",null,null),f("注：由于兼容性移动端部分可能不适配(目前只测试了ios17, safari、chrome都支持)")])},null),u("br",null,null),u(R,null,{default:()=>[u(R.Item,{label:"摄像头选择",colon:!0,extra:j.value?"当前没有可用的摄像头设备":null},{default:()=>[u(S,{value:r.value,"onUpdate:value":e=>r.value=e,options:w.value,disabled:j.value,class:"w-200"},null)]}),u(R.Item,{label:"麦克风选择",colon:!0},{default:()=>[u(S,{value:c.value,"onUpdate:value":e=>c.value=e,options:C.value,disabled:G.value,class:"w-200"},null)]}),u(W,{type:"primary",danger:F.value,onClick:J},{default:()=>[F.value?"停止录制":"开始录制"]})]}),!!g.value.length&&u(_,null,[u(U,null,null),u("strong",null,[f("已录制的成品："),u("span",{style:"font-size: 12px;color: #999"},[f("文件格式为h264编码的webm格式，没有做格式转换，下载后可以在浏览器中打开")])]),u("ul",null,[g.value.map(e=>u("li",null,[u("a",{href:e.url,target:"_blank"},[e.label,f("(点击查看)   ")]),f("/"),u(W,{type:"link",onClick:()=>X(e)},{default:()=>[f("下载")]})]))])]),F.value&&u(_,null,[u(U,null,null),c.value!=="disabled"&&u("canvas",{ref:m,height:60,style:{width:"100%"}},null),u("video",{ref:b,style:"max-width: 100%",autoplay:!0,muted:!0,playsinline:!0},null),f("正在录制...")]),u(U,null,null),u("h3",null,[f("效果预览：")]),u(oe,{gutter:16},{default:()=>[u($,{span:12},{default:()=>[f("PC演示"),u("video",{style:"max-width: 100%",playsinline:!0,controls:!0,src:"https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/mediarecord__desktop.mp4"},null)]}),u($,{span:12},{default:()=>[f("Mobile演示"),u("video",{style:"max-width: 100%",playsinline:!0,controls:!0,src:"https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/mediarecord__phone.MP4"},null)]})]})]})}});export{me as default};
